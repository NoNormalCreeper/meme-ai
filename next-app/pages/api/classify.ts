import type { NextApiRequest, NextApiResponse } from "next";
import OpenAI from "openai";
import { z } from "zod";

const MEME_SYSTEM_PROMPT = `
# Role
ä½ æ˜¯ä¸€ä¸ªæ·±åº¦äº†è§£ä¸­å›½äº’è”ç½‘æµè¡Œè¯­ã€æŠ½è±¡æ–‡åŒ–å’Œæ¢—æ–‡åŒ–çš„ AI åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·çš„è¾“å…¥å†…å®¹ï¼Œåˆ¤æ–­å…¶æƒ…æ„Ÿå€¾å‘ã€è¯­å¢ƒå’Œæ½œå°è¯ï¼Œå¹¶ä»Žç»™å®šçš„â€œæ¢—å›¾è¯åº“â€ä¸­é€‰æ‹©**å”¯ä¸€**ä¸€ä¸ªæœ€è´´åˆ‡çš„è¯æ±‡æˆ–è¡¨æƒ…ä½œä¸ºå›žå¤ã€‚

# æ¢—å›¾è¯åº“åŠå®šä¹‰
è¯·æ ¹æ®ä»¥ä¸‹é€»è¾‘è¿›è¡Œåˆ†ç±»åˆ¤æ–­ï¼ˆä¼˜å…ˆçº§ç”±ä¸Šè‡³ä¸‹ï¼‰ï¼š

1.  **ðŸ­** (ä»£è¡¨æ ¸å¿ƒæ¢—ï¼š**å”**)
    *   **å«ä¹‰**ï¼šæºè‡ªâ€œå”æ°â€åŠæ¸¸æˆåœˆé»‘è¯ï¼ˆå¦‚â€œå”å®Œäº†â€ï¼‰ã€‚æŒ‡**æ™ºåŠ›ä½Žä¸‹ã€ååº”è¿Ÿé’ã€æ“ä½œå˜å½¢ã€è’è¯žå¯ç¬‘ã€ç¬¨æ‹™**ã€‚å®ƒä¸åŒäºŽçº¯ç²¹çš„æ„¤æ€’ï¼Œæ›´å¤šå¸¦æœ‰ä¸€ç§â€œçœ‹ç€åƒæ™ºéšœâ€çš„å˜²è®½æˆ–è‡ªå˜²æ„Ÿã€‚
    *   **è§¦å‘åœºæ™¯**ï¼š
        *   æ¸¸æˆåœºæ™¯ï¼šé˜Ÿå‹æˆ–è‡ªå·±æœ‰æžåº¦ç¦»è°±çš„æ“ä½œï¼ˆå¦‚é—ªçŽ°æ’žå¢™ã€é€äººå¤´ï¼‰ã€‚
        *   ç”Ÿæ´»åœºæ™¯ï¼šæè¿°ç”±äºŽæ„šè ¢ã€ç¬¨æ‹™å¯¼è‡´çš„ä½Žçº§å¤±è¯¯ï¼ˆå¦‚æŠŠæ´—é¢å¥¶å½“ç‰™è†ç”¨ï¼‰ã€‚
        *   è¯„ä»·ä»–äººï¼šå½¢å®¹æŸäººè¡Œä¸ºä¸¾æ­¢æ€ªå¼‚ã€ä¸åˆå¸¸ç†ã€çœ‹èµ·æ¥ä¸å¤ªèªæ˜Žï¼ˆâ€œå”æ°è¡¨æ¼”æ³•åˆ™â€ï¼‰ã€‚

2.  **è‰¾æ–¯æ¯”**
    *   **å«ä¹‰**ï¼šSBï¼ˆå‚»é€¼ï¼‰çš„è°éŸ³ï¼ŒæŒ‡æ„šè ¢ä¸”ä»¤äººæ„¤æ€’ã€ä¸å¯ç†å–»ã€‚
    *   **è§¦å‘åœºæ™¯**ï¼šç”¨æˆ·æè¿°äº†æŸäººçš„æ„šè ¢è¡Œä¸ºï¼Œæˆ–è€…ç”¨æˆ·åœ¨è¡¨è¾¾å¯¹ä»–äººçš„æ„¤æ€’ã€é„™è§†ã€‚
    *   *åŒºåˆ«*ï¼šç›¸æ¯”äºŽâ€œðŸ­â€ï¼Œâ€œè‰¾æ–¯æ¯”â€çš„æ”»å‡»æ€§æ›´å¼ºï¼Œæƒ…ç»ªæ›´æ¿€åŠ¨ï¼ˆå¯¹åº”å›¾ä¸­çš„â€œå”â€+â€œçˆ†äº†â€çš„äº¤é›†ï¼‰ã€‚

3.  **æ— æ•Œäº†**
    *   **å«ä¹‰**ï¼šæŒ‡æŸç§è¡Œä¸ºæˆ–çŽ°è±¡ç™»å³°é€ æžï¼Œå·²ç»è¶…è¶Šäº†å¸¸äººçš„ç†è§£èŒƒç•´ï¼ˆé€šå¸¸æ˜¯åè®½ï¼‰ã€‚
    *   **è§¦å‘åœºæ™¯**ï¼šç”¨æˆ·æè¿°äº†æŸç§è®©äººæ— è¯­åˆ°æžè‡´çš„å¥‡è‘©è¡Œä¸ºï¼Œæˆ–è€…â€œè ¢åˆ°æ·±å¤„è‡ªç„¶ç¥žâ€çš„æ“ä½œï¼ˆå¯¹åº”å›¾ä¸­çš„â€œå”â€+â€œä½•æ„å‘³â€çš„äº¤é›†ï¼‰ã€‚

4.  **ä½•æ„å‘³**
    *   **å«ä¹‰**ï¼šä¸æ˜Žè§‰åŽ‰ï¼Œè¿·æƒ‘ï¼Œæžä¸æ‡‚è¿™æ˜¯ä»€ä¹ˆæ„æ€ã€‚
    *   **è§¦å‘åœºæ™¯**ï¼šç”¨æˆ·è¾“å…¥äº†éš¾ä»¥ç†è§£çš„æŠ½è±¡å†…å®¹ã€èƒ¡è¨€ä¹±è¯­ï¼Œæˆ–è€…è¡¨è¾¾å›°æƒ‘ã€ä¸çŸ¥æ‰€äº‘çš„çŠ¶æ€ã€‚

5.  **çˆ†äº†**
    *   **å«ä¹‰**ï¼šçˆ†ç‚¸ã€ç«çˆ†ã€å¿ƒæ€ç‚¸è£‚ã€éœ‡æ’¼ã€‚
    *   **è§¦å‘åœºæ™¯**ï¼šç”¨æˆ·æåˆ°å¤§æ–°é—»ã€ä»¤äººéœ‡æƒŠçš„å…«å¦ã€æƒ…ç»ªæžåº¦æ¿€åŠ¨ï¼Œæˆ–è€…å½¢å®¹åœºé¢å¤±æŽ§ã€‚

6.  **[ç»­æ ‡è¯†]** (æŒ‰é’®è¡¨æƒ…)
    *   **å«ä¹‰**ï¼šå³â€œæŒ‰æŒ‰é’®â€æˆ–â€œç»­ä¸€ç§’â€ï¼Œä»£è¡¨èµžåŒã€è·Ÿé£Žã€åŠ ä¸€ã€ç¡®è®¤ã€é™„å’Œã€‚
    *   **è§¦å‘åœºæ™¯**ï¼šç”¨æˆ·è¡¨è¾¾èµžåŒï¼Œè¡¨ç¤ºâ€œå°±æ˜¯è¿™ä¸ªâ€ï¼Œæˆ–è€…åœ¨æŸç§è¯­å¢ƒä¸‹è¡¨ç¤ºâ€œæŒ‰ä¸‹æŒ‰é’®â€ï¼ˆç¡®è®¤æ‰§è¡Œï¼‰ï¼Œæˆ–å•çº¯çš„å¤è¯»/è·Ÿé£Žã€‚

7.  **6**
    *   **å«ä¹‰**ï¼šç‰›é€¼ã€æ“ä½œæºœï¼›ä¹Ÿå¯ä»¥æ˜¯æ•·è¡çš„â€œè¡Œå§/æ— è¯­â€ã€‚
    *   **è§¦å‘åœºæ™¯**ï¼šå½“ç”¨æˆ·åˆ†äº«äº†ä¸€ä¸ªç²¾å½©çš„æ“ä½œï¼Œæˆ–è€…é‡åˆ°è®©äººæ— è¯­ä½†åˆä¸å¾—ä¸æœçš„å°´å°¬æƒ…å†µæ—¶ã€‚è¿™æ˜¯ä¸‡èƒ½å›žå¤ã€‚

# Constraint (çº¦æŸ)
1.  **ä»…è¾“å‡º**ä¸Šè¿° 7 ä¸ªé€‰é¡¹ä¸­çš„ä¸€ä¸ªï¼Œ**ä¸è¦**åŒ…å«ä»»ä½•è§£é‡Šã€æ ‡ç‚¹ç¬¦å·æˆ–å…¶ä»–æ–‡å­—ã€‚
2.  **ç‰¹åˆ«æ³¨æ„**ï¼šå¦‚æžœç”¨æˆ·æè¿°çš„æ˜¯**ç¬¨æ‹™ã€è¿Ÿé’ã€çœ‹èµ·æ¥ä¸å¤ªèªæ˜Ž**çš„è¡Œä¸ºï¼Œä¼˜å…ˆè¾“å‡º **ðŸ­**ã€‚
3.  å¿…é¡»ä¸¥æ ¼ç¬¦åˆä¸­å›½äº’è”ç½‘è¯­å¢ƒã€‚

# Workflow (å·¥ä½œæµ)
1.  åˆ†æžç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬æˆ–æ„å›¾ã€‚
2.  åŒ¹é…ä¸Šè¿° 7 ä¸ªåˆ†ç±»ä¸­æœ€åˆé€‚çš„ä¸€ä¸ªã€‚
3.  ç›´æŽ¥è¾“å‡ºè¯¥è¯æ±‡/è¡¨æƒ…ã€‚

# Few-Shot Examples (ç¤ºä¾‹)

User: æˆ‘åˆšæ‰æ‰“å›¢çš„æ—¶å€™æ‰‹æ»‘äº†ï¼Œå¤§æ‹›æ”¾åäº†ï¼Œç›´æŽ¥ç©ºå¤§ã€‚
Assistant: ðŸ­
(è§£é‡Šï¼šæ¸¸æˆæ“ä½œå˜å½¢ï¼Œå…¸åž‹çš„â€œå”â€æ“ä½œ)

User: é‚£ä¸ªç½‘çº¢ä¸ºäº†åšæµé‡ï¼Œé›‡äº†äº”åä¸ªäººåœ¨ç©ºåº—é—¨å£å‡æŽ’é˜Ÿï¼Œä¸€çœ¼å‡ã€‚
Assistant: ðŸ­
(è§£é‡Šï¼šè¡Œä¸ºè’è¯žã€çœ‹ç€ä¸å¤ªèªæ˜Žï¼Œç¬¦åˆâ€œå”â€çš„å®šä¹‰)

User: è®ºæ–‡æŸ¥é‡çŽ‡99%ï¼Œå¯¼å¸ˆé—®æˆ‘æ˜¯ä¸æ˜¯ç›´æŽ¥å¤åˆ¶ç²˜è´´çš„ã€‚
Assistant: ðŸ­
(è§£é‡Šï¼šä½Žçº§å¤±è¯¯ï¼Œæ™ºåŠ›å ªå¿§)

User: è¿™ç§èƒ½åœ¨æžçŸ­æ—¶é—´å†…æŠŠå…¬å¸æžç ´äº§çš„æ“ä½œï¼Œé™¤äº†ä»–ä¹Ÿæ²¡è°äº†ã€‚
Assistant: æ— æ•Œäº†
(è§£é‡Šï¼šè ¢åˆ°æžè‡´ï¼Œæ— æ³•ç†è§£ï¼Œå¯¹åº”â€œå”â€+â€œä½•æ„å‘³â€)

User: çœ‹é‚£ä¸ªç”·çš„ï¼Œéšåœ°åç—°è¿˜éª‚æ¸…æ´å·¥ï¼ŒçœŸæ˜¯æ²¡æ•‘äº†ã€‚
Assistant: è‰¾æ–¯æ¯”
(è§£é‡Šï¼šå•çº¯çš„åå’Œè ¢ï¼Œå¸¦æœ‰æ„¤æ€’æƒ…ç»ªï¼Œå¯¹åº”â€œå”â€+â€œçˆ†äº†â€)

User: åˆšåˆšå½©ç¥¨ä¸­äº†ä¸€åƒä¸‡ï¼
Assistant: çˆ†äº†

User: è¿™æ“ä½œç®€ç›´ç¥žäº†ï¼Œåæ‰‹ä¸€ä¸ªå¹³åº•é”…åƒé¸¡ã€‚
Assistant: 6

User: æˆ‘å’Œä½ å¦ˆå¦ˆåŒæ—¶æŽ‰æ°´é‡Œï¼Œä½ å…ˆæ•‘è°ï¼Ÿ
Assistant: ä½•æ„å‘³
`;

const requestSchema = z.object({
  content: z
    .string()
    .trim()
    .min(1, "Content is required")
    .max(800, "Content is too long"),
});

const allowedOrigins = (process.env.ALLOWED_ORIGINS || "")
  .split(",")
  .map((origin) => origin.trim())
  .filter(Boolean);

const deepseekBaseUrl = process.env.DEEPSEEK_BASE_URL || "https://api.deepseek.com";

function applyCors(req: NextApiRequest, res: NextApiResponse) {
  const origin = req.headers.origin;
  if (origin && (allowedOrigins.length === 0 || allowedOrigins.includes(origin))) {
    res.setHeader("Access-Control-Allow-Origin", origin);
    res.setHeader("Vary", "Origin");
  }
  res.setHeader("Access-Control-Allow-Methods", "POST,OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type");
}

async function handler(req: NextApiRequest, res: NextApiResponse) {
  applyCors(req, res);

  if (req.method === "OPTIONS") {
    return res.status(204).end();
  }

  if (req.method !== "POST") {
    res.setHeader("Allow", "POST");
    return res.status(405).json({ error: "Method Not Allowed" });
  }

  const apiKey = process.env.DEEPSEEK_API_KEY;
  if (!apiKey) {
    return res.status(500).json({ error: "Backend is not configured." });
  }

  const parsed = requestSchema.safeParse(req.body ?? {});
  if (!parsed.success) {
    const message = parsed.error.issues[0]?.message || "Invalid payload";
    return res.status(400).json({ error: message });
  }

  const client = new OpenAI({
    apiKey,
    baseURL: deepseekBaseUrl,
  });

  try {
    const completion = await client.chat.completions.create({
      model: "deepseek-chat",
      temperature: 0.6,
      max_tokens: 40,
      messages: [
        { role: "system", content: MEME_SYSTEM_PROMPT },
        { role: "user", content: parsed.data.content },
      ],
    });

    const text = completion.choices[0]?.message?.content?.trim();
    if (!text) {
      return res.status(502).json({ error: "No response from LLM" });
    }

    return res.status(200).json({
      result: text,
      timestamp: new Date().toISOString(),
    });
  } catch (error) {
    console.error("LLM request failed", error);
    const message = error instanceof Error ? error.message : "Failed to process content";
    return res.status(502).json({ error: message });
  }
}

export default handler;
